<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Student | Dashboard</title>
    <style>
        :root {
            --primary-color: #007367; --danger-color: #e74c3c; --safe-color: #2ecc71;
            --background-color: #f4f7f6; --card-bg-color: #ffffff; --text-dark-color: #2c3e50;
            --text-light-color: #8a99a7; --border-color: #e9ecef;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-dark-color); }
        .view { display: none; }
        
        /* Login Page Styles */
        #login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-container { width: 100%; max-width: 400px; text-align: center; }
        .login-card { background: var(--card-bg-color); padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .login-card h1 { margin-bottom: 25px; font-size: 1.8em; }
        .login-form-group { text-align: left; margin-bottom: 20px; }
        .login-form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .login-form-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; }
        #login-btn { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; }
        
        /* Main Dashboard Styles */
        .app-wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--card-bg-color); padding: 20px; display: flex; flex-direction: column; align-items: center; border-right: 1px solid var(--border-color); }
        .profile { text-align: center; margin-top: 20px; }
        .profile-name { font-size: 1.2em; font-weight: 600; }
        .profile-id { color: var(--text-light-color); margin-bottom: 20px; }
        .sidebar-nav { width: 100%; }
        .sidebar-nav a { display: block; padding: 12px 15px; border-radius: 8px; text-decoration: none; color: var(--text-dark-color); font-weight: 500; margin-bottom: 5px; transition: background-color 0.2s; cursor: pointer; }
        .sidebar-nav a:hover { background-color: var(--background-color); }
        .sidebar-nav a.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .header { background-color: var(--primary-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; min-height: 60px; }
        .header-title { font-weight: 600; font-size: 1.2em; }
        .header-user-info { display: none; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions button { font-size: 0.8em; font-weight: 500; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        
        .content-area { padding: 30px; flex-grow: 1; overflow-y: auto; }
        .dashboard-grid { display: grid; gap: 25px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .card { background-color: var(--card-bg-color); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-header h2 { margin: 0; font-size: 1.1em; }

        /* Grade Estimator Styles */
        #grade-estimator-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .estimator-card h3 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .estimator-card .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px 20px; margin-bottom: 15px; }
        .estimator-card .input-group { position: relative; display: flex; flex-direction: column; }
        .estimator-card .input-group label { font-size: 0.9em; color: var(--text-light-color); margin-bottom: 4px; }
        .estimator-card .input-group input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; }
        .estimator-card .input-group input.invalid { border-color: var(--danger-color); }
        .validation-message { font-size: 0.8em; color: var(--danger-color); font-weight: 500; margin-top: 4px; height: 1em;}
        .estimator-card .result-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: center; }
        .estimator-card .result-area span { font-weight: bold; font-size: 1.4em; }
        .sgpa-calculator { text-align: center; margin-top: 30px; }
        .sgpa-calculator button { max-width: 300px; }
        #sgpa-result { font-size: 1.5em; font-weight: bold; margin-top: 15px; }
        
        /* Timetable Styles */
        .timetable-table { display: table; width: 100%; border-collapse: collapse; font-size: 0.8em; }
        .timetable-table th, .timetable-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
        .timetable-table th { background-color: var(--background-color); font-weight: 600; }
        .timetable-table .class-cell { font-weight: 600; color: white; }
        .timetable-tabs { display: none; }

        /* Other Styles */
        #today-schedule-card ul { list-style: none; display: flex; flex-wrap: wrap; gap: 8px; } #today-schedule-card li { background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; } #full-day-bunk-btn { width: 100%; margin-top: 15px; padding: 10px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; } #total-attendance-card .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; } .stat .label { font-size: 0.9em; color: var(--text-light-color); margin-bottom: 5px; } .stat .value { font-size: 1.8em; font-weight: 600; } #total-attendance-card .bunks-left { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 1.2em; font-weight: 600; } #subject-dashboard h2 { margin-bottom: 20px; } .subject-card { border-left: 5px solid var(--primary-color); } .subject-card.is-safe { border-left-color: var(--safe-color); } .subject-card.is-danger { border-left-color: var(--danger-color); } .card-main-stats { display: flex; justify-content: space-around; text-align: center; margin-bottom: 15px; } .action-area { display: flex; gap: 10px; } .action-area button { width: 100%; padding: 8px; font-size: 0.9em; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; } .action-area .bunk-btn { background-color: var(--danger-color); color: white; } .action-area .undo-btn { background-color: var(--dark-grey); color: white; } .bunks-left.safe { color: var(--safe-color); } .bunks-left.danger { color: var(--danger-color); } .controls, .setup-card { display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between; align-items: center; } .controls input, .setup-card input { padding: 8px; border-radius: 5px; border: 1px solid #ddd; } .setup-card button, .settings-btn { padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; } .settings-btn { background-color: var(--dark-grey); } .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; } .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; } .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; } .modal-header h2 { margin: 0; } .modal-header .close-btn { font-size: 2em; cursor: pointer; font-weight: bold; }
        
        /* Responsive Styles */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .header-title { display: none; }
            .header-user-info { display: block; text-align: left; }
            #header-profile-name { font-size: 0.9em; font-weight: 600; }
            #header-profile-id { font-size: 0.7em; opacity: 0.8; }
        }
        @media (max-width: 768px) {
            .dashboard-area { padding: 15px; }
            #total-attendance-card .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            /* Responsive Timetable */
            #timetable-view .timetable-table { display: none; }
            #timetable-view .timetable-tabs { display: block; }
            .tab-nav { display: flex; overflow-x: auto; border-bottom: 2px solid var(--border-color); margin-bottom: 15px;}
            .tab-nav-btn { padding: 10px 15px; border: none; background: none; font-weight: 600; cursor: pointer; flex-shrink: 0; white-space: nowrap; }
            .tab-nav-btn.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
            .tab-content { display: none; }
            .tab-content.active { display: block; }
            .tab-content ul { list-style: none; }
            .tab-content li { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--background-color); border-radius: 5px; margin-bottom: 8px; }
        }
    </style>
</head>
<body>
    <div id="login-page">
        <div class="login-container"><div class="login-card"><h1>G-Student Login</h1><form id="login-form"><div class="login-form-group"><label for="regd-no-input">Registration Number</label><input type="text" id="regd-no-input" placeholder="Enter your number" required></div><button type="submit" id="login-btn">Login</button></form></div></div>
    </div>
    <div id="dashboard-page">
        <div class="app-wrapper">
            <aside class="sidebar">
                <div class="profile"><div id="sidebar-profile-name" class="profile-name"></div><div id="sidebar-profile-id" class="profile-id"></div></div>
                <nav class="sidebar-nav"><a class="active" onclick="showView('attendance-view', this)">Attendance</a><a onclick="showView('grade-estimator-view', this)">Grade Estimator</a><a onclick="showView('timetable-view', this)">Time table</a></nav>
            </aside>
            <div class="main-content">
                <header class="header">
                    <span class="header-title">G-Student</span>
                    <div class="header-user-info"><div id="header-profile-name"></div><div id="header-profile-id"></div></div>
                    <div class="header-actions">
                        <button onclick="showView('timetable-view')">Time Table</button>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </header>
                <main id="attendance-view" class="content-area view">
                    <div class="dashboard-grid">
                        <div id="today-schedule-card" class="card"></div>
                        <div id="total-attendance-card" class="card"><div class="card-header"><h2>Attendance</h2></div><div id="total-stats-container"></div></div>
                        <div id="setup-card" class="card setup-card"><div><label for="start-date">Semester Start Date:</label><input type="date" id="start-date"></div><button onclick="startTracking()">Calculate & Start</button></div>
                        <div id="controls-card" class="card controls"><div><label for="min-percentage">Minimum %:</label><input type="number" id="min-percentage" value="75" onchange="renderDashboard()"></div><button class="settings-btn" onclick="openSettings()">⚙️ Settings</button></div>
                    </div>
                    <div id="subject-dashboard" style="margin-top: 30px;"><h2>Individual Subjects</h2><div id="dashboard" class="dashboard-grid"></div></div>
                </main>
                <main id="grade-estimator-view" class="content-area view">
                    <h2>Grade Estimator</h2>
                    <p style="text-align:center; max-width: 600px; margin: -10px auto 20px auto; color: var(--text-light-color);">Enter your marks to estimate your grade and SGPA.</p>
                    <div id="grade-estimator-grid"></div>
                    <div class="sgpa-calculator card"><button onclick="calculateSGPA()">Calculate Estimated SGPA</button><div id="sgpa-result"></div></div>
                </main>
                <main id="timetable-view" class="content-area view">
                    <h2>Full Weekly Timetable</h2>
                    <div class="card" id="timetable-container"></div>
                </main>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal"> <div class="modal-content"><div class="modal-header"><h2>Settings</h2><span class="close-btn" onclick="closeSettings()">&times;</span></div><p>Enter total classes for each subject.</p><div id="settings-list"></div><button onclick="saveSettings()" style="width: 100%; padding: 12px; background-color: var(--safe-color); color: white; border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px;">Save Settings</button></div></div>

    <script>
        // --- All JavaScript logic from the previous final version is placed here ---
        const userDatabase = [ { name: 'SRAVAN NAMANI', regdNo: '2025228568', branch: 'CSE' }, { name: 'DATA SCIENCE FRIEND', regdNo: '2025221234', branch: 'DS' } ];
        const timeSlots = ['08:00-08:50', '09:00-09:50', '10:00-10:50', '11:00-11:50', '11:50-1:00', '1:00-1:50', '2:00-2:50'];
        const timetablesByBranch = { 'CSE': { simple: { 0: [], 1: ['Mathematical Foundations of Computer Science', 'Advanced Data Structures', 'Algorithms and Analysis', 'Research Methodology and IPR', 'Data Science Lab', 'Data Science Lab'], 2: ['Advanced Data Structures Lab', 'Advanced Data Structures Lab', 'Algorithms and Analysis', 'English for Research Paper Writing', 'Algorithms and Analysis Lab', 'Algorithms and Analysis Lab'], 3: ['Machine Learning', 'Mathematical Foundations of Computer Science', 'Advanced Data Structures', 'Data Science', 'Machine Learning Lab', 'Machine Learning Lab'], 4: ['Machine Learning', 'English for Research Paper Writing', 'Algorithms and Analysis', 'Data Science'], 5: ['Machine Learning', 'Research Methodology and IPR', 'Data Science', 'Advanced Data Structures', 'Mathematical Foundations of Computer Science'], 6: [] }, full: { 'Monday': [ { time: '08:00-08:50', subject: 'Mathematical Foundations of Computer Science' }, { time: '09:00-09:50', subject: 'Advanced Data Structures' }, { time: '10:00-10:50', subject: 'Algorithms and Analysis' }, { time: '11:00-11:50', subject: 'Research Methodology and IPR' }, { time: '1:00-1:50', subject: 'Data Science Lab', span: 2 } ], 'Tuesday': [ { time: '08:00-08:50', subject: 'Advanced Data Structures Lab', span: 2 }, { time: '10:00-10:50', subject: 'Algorithms and Analysis' }, { time: '11:00-11:50', subject: 'English for Research Paper Writing' }, { time: '1:00-1:50', subject: 'Algorithms and Analysis Lab', span: 2 } ], 'Wednesday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '09:00-09:50', subject: 'Mathematical Foundations of Computer Science' }, { time: '10:00-10:50', subject: 'Advanced Data Structures' }, { time: '11:00-11:50', subject: 'Data Science' }, { time: '1:00-1:50', subject: 'Machine Learning Lab', span: 2 } ], 'Thursday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '10:00-10:50', subject: 'English for Research Paper Writing' }, { time: '11:00-11:50', subject: 'Algorithms and Analysis' }, { time: '1:00-1:50', subject: 'Data Science' } ], 'Friday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '09:00-09:50', subject: 'Research Methodology and IPR' }, { time: '10:00-10:50', subject: 'Data Science' }, { time: '11:00-11:50', subject: 'Advanced Data Structures' }, { time: '1:00-1:50', subject: 'Mathematical Foundations of Computer Science' } ] }, colors: { 'Mathematical Foundations of Computer Science': '#8e44ad', 'Advanced Data Structures': '#2980b9', 'Algorithms and Analysis': '#27ae60', 'Research Methodology and IPR': '#f39c12', 'Data Science Lab': '#d35400', 'Advanced Data Structures Lab': '#16a085', 'English for Research Paper Writing': '#7f8c8d', 'Algorithms and Analysis Lab': '#2c3e50', 'Machine Learning': '#c0392b', 'Data Science': '#d35400', 'Machine Learning Lab': '#c0392b' } }, 'DS': { simple: { 0: [], 1: ['Advanced Data Structures', 'Algorithms and Analysis', 'Research Methodology & IPR', 'Data Science Lab', 'Data Science Lab'], 2: ['Advanced Data Structures Lab', 'Advanced Data Structures Lab', 'Algorithms and Analysis', 'English for Research Paper Writing', 'Algorithms and Analysis Lab', 'Algorithms and Analysis Lab'], 3: ['Machine Learning', 'Statistical Modeling', 'Advanced Data Structures', 'Data Science', 'Machine Learning Lab', 'Machine Learning Lab'], 4: ['Machine Learning', 'Statistical Modeling', 'English for Research Paper Writing', 'Algorithms and Analysis', 'Data Science'], 5: ['Machine Learning', 'Research Methodology & IPR', 'Data Science', 'Advanced Data Structures', 'Statistical Modeling'], 6: [] }, full: { 'Monday': [ { time: '09:00-09:50', subject: 'Advanced Data Structures' }, { time: '10:00-10:50', subject: 'Algorithms and Analysis' }, { time: '11:00-11:50', subject: 'Research Methodology & IPR' }, { time: '1:00-1:50', subject: 'Data Science Lab', span: 2 } ], 'Tuesday': [ { time: '08:00-08:50', subject: 'Advanced Data Structures Lab', span: 2 }, { time: '10:00-10:50', subject: 'Algorithms and Analysis' }, { time: '11:00-11:50', subject: 'English for Research Paper Writing' }, { time: '1:00-1:50', subject: 'Algorithms and Analysis Lab', span: 2 } ], 'Wednesday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '09:00-09:50', subject: 'Statistical Modeling' }, { time: '10:00-10:50', subject: 'Advanced Data Structures' }, { time: '11:00-11:50', subject: 'Data Science' }, { time: '1:00-1:50', subject: 'Machine Learning Lab', span: 2 } ], 'Thursday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '09:00-09:50', subject: 'Statistical Modeling' }, { time: '10:00-10:50', subject: 'English for Research Paper Writing' }, { time: '11:00-11:50', subject: 'Algorithms and Analysis' }, { time: '1:00-1:50', subject: 'Data Science' } ], 'Friday': [ { time: '08:00-08:50', subject: 'Machine Learning' }, { time: '09:00-09:50', subject: 'Research Methodology & IPR' }, { time: '10:00-10:50', subject: 'Data Science' }, { time: '11:00-11:50', subject: 'Advanced Data Structures' }, { time: '1:00-1:50', subject: 'Statistical Modeling' } ] }, colors: { 'Advanced Data Structures': '#2980b9', 'Algorithms and Analysis': '#27ae60', 'Research Methodology & IPR': '#f39c12', 'Data Science Lab': '#d35400', 'Advanced Data Structures Lab': '#16a085', 'English for Research Paper Writing': '#7f8c8d', 'Algorithms and Analysis Lab': '#2c3e50', 'Machine Learning': '#c0392b', 'Data Science': '#d35400', 'Machine Learning Lab': '#c0392b', 'Statistical Modeling': '#8e44ad' } } };
        const courseDetailsByBranch = { 'CSE': { 'Advanced Data Structures': { credits: 4, type: 'Integrated' }, 'Mathematical Foundations of Computer Science': { credits: 3, type: 'Theory' }, 'Algorithms and Analysis': { credits: 4, type: 'Integrated' }, 'Machine Learning': { credits: 4, type: 'Integrated' }, 'Data Science': { credits: 4, type: 'Integrated' }, 'Research Methodology and IPR': { credits: 2, type: 'Theory' }, 'English for Research Paper Writing': { credits: 0, type: 'Theory' }, 'Data Science Lab':{credits:0, type:'Lab'},'Advanced Data Structures Lab':{credits:0, type:'Lab'},'Algorithms and Analysis Lab':{credits:0, type:'Lab'},'Machine Learning Lab':{credits:0, type:'Lab'} }, 'DS': { 'Advanced Data Structures': { credits: 4, type: 'Integrated' }, 'Algorithms and Analysis': { credits: 4, type: 'Integrated' }, 'Research Methodology & IPR': { credits: 2, type: 'Theory' }, 'Data Science': { credits: 4, type: 'Integrated' }, 'Advanced Data Structures Lab': { credits: 0, type: 'Lab' }, 'English for Research Paper Writing': { credits: 0, type: 'Theory' }, 'Algorithms and Analysis Lab': { credits: 0, type: 'Lab' }, 'Machine Learning': { credits: 4, type: 'Integrated' }, 'Statistical Modeling': { credits: 3, type: 'Theory' }, 'Data Science Lab': { credits: 0, type: 'Lab' }, 'Machine Learning Lab': { credits: 0, type: 'Lab' } } };
        let subjectData = {}; let currentUserTimetable = {};
        function getCurrentUserRegdNo() { return sessionStorage.getItem('currentUserRegdNo'); }
        function getUserDataKey(regdNo, type) { return `${type}Data_${regdNo}`; }
        function init() { if (!localStorage.getItem('userDatabase')) { localStorage.setItem('userDatabase', JSON.stringify(userDatabase)); } const currentUser = getCurrentUserRegdNo(); if (currentUser) { document.getElementById('login-page').style.display = 'none'; document.getElementById('dashboard-page').style.display = 'block'; loadDashboardForUser(currentUser); } else { document.getElementById('login-page').style.display = 'flex'; document.getElementById('dashboard-page').style.display = 'none'; } }
        function handleLogin(event) { event.preventDefault(); const regdNo = document.getElementById('regd-no-input').value.trim(); if (!regdNo) { alert("Please enter a Registration Number."); return; } const userExists = userDatabase.find(u => u.regdNo === regdNo); if (userExists) { sessionStorage.setItem('currentUserRegdNo', regdNo); init(); } else { alert("Registration Number not found. Please edit the HTML file to add this user."); } }
        function logout() { sessionStorage.removeItem('currentUserRegdNo'); init(); }
        function showView(viewId, element) { document.querySelectorAll('.content-area.view').forEach(v => v.style.display = 'none'); document.getElementById(viewId).style.display = 'block'; document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active')); if (element) { element.classList.add('active'); } }
        function loadDashboardForUser(regdNo) { const currentUser = userDatabase.find(u => u.regdNo === regdNo); if (!currentUser) { logout(); return; } const branch = currentUser.branch; if (!timetablesByBranch[branch]) { alert(`Timetable for branch "${branch}" not found!`); logout(); return; } currentUserTimetable = timetablesByBranch[branch]; document.getElementById('sidebar-profile-name').innerText = currentUser.name; document.getElementById('sidebar-profile-id').innerText = `(${currentUser.regdNo} - ${branch})`; document.getElementById('header-profile-name').innerText = currentUser.name; document.getElementById('header-profile-id').innerText = `(${currentUser.regdNo} - ${branch})`; showView('attendance-view', document.querySelector('.sidebar-nav a')); loadData(); renderTodaysSchedule(); renderFullTimetable(); renderGradeEstimator(); }
        function loadData() { const regdNo = getCurrentUserRegdNo(); if (!regdNo) return; const savedAttData = localStorage.getItem(getUserDataKey(regdNo, 'attendance')); const savedStartDate = localStorage.getItem(getUserDataKey(regdNo, 'startDate')); if (savedStartDate) document.getElementById('start-date').value = savedStartDate; if (savedAttData) { subjectData = JSON.parse(savedAttData); } else { getUniqueSubjects().forEach(name => { subjectData[name] = { attended: 0, bunked: 0, totalInSem: 0 }; }); } renderDashboard(); populateSettingsModal(); }
        function saveData(type) { const regdNo = getCurrentUserRegdNo(); if (!regdNo) return; if (type === 'attendance') { localStorage.setItem(getUserDataKey(regdNo, 'attendance'), JSON.stringify(subjectData)); const startDate = document.getElementById('start-date').value; if (startDate) localStorage.setItem(getUserDataKey(regdNo, 'startDate'), startDate); } else if (type === 'grades') { const gradeData = {}; getUniqueSubjects().forEach(subjectName => { const details = courseDetailsByBranch[userDatabase.find(u=>u.regdNo === getCurrentUserRegdNo()).branch][subjectName]; if(!details || details.credits === 0) return; const cleanSubName = subjectName.replace(/[\s&/]/g, ''); gradeData[subjectName] = { internal: document.getElementById(`internal_${cleanSubName}`)?.value, external: document.getElementById(`external_${cleanSubName}`)?.value, lab_internal: document.getElementById(`lab_internal_${cleanSubName}`)?.value }; }); localStorage.setItem(getUserDataKey(regdNo, 'grades'), JSON.stringify(gradeData)); } }
        function renderFullTimetable() { const container = document.getElementById('timetable-container'); container.innerHTML = ''; let tableHTML = '<table class="timetable-table"><thead><tr><th>Weekday</th>' + timeSlots.map(slot => `<th>${slot}</th>`).join('') + '</tr></thead><tbody>'; ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { tableHTML += `<tr><td class="day-header">${day}</td>`; const daySchedule = currentUserTimetable.full[day] || []; for (let i = 0; i < timeSlots.length; ) { const slot = timeSlots[i]; if (slot === '11:50-1:00') { tableHTML += '<td class="lunch-cell">LUNCH</td>'; i++; continue; } const classInfo = daySchedule.find(c => c.time === slot); if (classInfo) { const span = classInfo.span || 1; const color = currentUserTimetable.colors[classInfo.subject] || '#bdc3c7'; tableHTML += `<td class="class-cell" colspan="${span}" style="background-color: ${color};">${classInfo.subject}</td>`; i += span; } else { tableHTML += '<td>-</td>'; i++; } } tableHTML += '</tr>'; }); tableHTML += '</tbody></table>'; let tabsHTML = '<div class="timetable-tabs"><div class="tab-nav">'; ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach((day, index) => { tabsHTML += `<button class="tab-nav-btn ${index === 0 ? 'active' : ''}" onclick="openTimetableTab(event, '${day}')">${day.substring(0,3)}</button>`; }); tabsHTML += '</div>'; ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach((day, index) => { tabsHTML += `<div id="${day}" class="tab-content ${index === 0 ? 'active' : ''}"><ul>`; (currentUserTimetable.full[day] || []).forEach(c => { tabsHTML += `<li><span>${c.time}</span><strong>${c.subject}</strong></li>` }); tabsHTML += `</ul></div>`; }); tabsHTML += '</div>'; container.innerHTML = tableHTML + tabsHTML; }
        function openTimetableTab(evt, dayName) { document.querySelectorAll('#timetable-container .tab-content').forEach(tc => tc.classList.remove('active')); document.querySelectorAll('#timetable-container .tab-nav-btn').forEach(tb => tb.classList.remove('active')); document.getElementById(dayName).classList.add('active'); evt.currentTarget.classList.add('active'); }
        function renderTodaysSchedule() { const card = document.getElementById('today-schedule-card'); const today = new Date(); const dateString = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const classesToday = currentUserTimetable.simple[today.getDay()] || []; let cardContent = `<div class="card-header"><h2>Today's Time Table</h2></div><p style="text-align:center; font-weight:500; margin-bottom:15px;">${dateString}</p>`; if (classesToday.length > 0) { cardContent += `<ul>${classesToday.map(s => `<li>${s}</li>`).join('')}</ul>`; cardContent += `<button id="full-day-bunk-btn" onclick="bunkFullDay()">Bunk Full Day (${classesToday.length} Classes)</button>`; } else { cardContent += '<p style="text-align: center; font-weight: 500;">No classes scheduled for today!</p>'; } card.innerHTML = cardContent; }
        function bunkFullDay() { const classesToday = currentUserTimetable.simple[new Date().getDay()] || []; if (classesToday.length === 0) { alert("No classes to bunk today!"); return; } let bunkedCount = 0; classesToday.forEach(subjectName => { if (subjectData[subjectName] && subjectData[subjectName].attended > 0) { subjectData[subjectName].attended--; subjectData[subjectName].bunked++; bunkedCount++; } }); if (bunkedCount > 0) { saveData('attendance'); renderDashboard(); alert(`${bunkedCount} class(es) for today have been marked as bunked.`); } else { alert("Could not bunk classes. Make sure attendance has been calculated."); } }
        function getUniqueSubjects() { return Array.from(new Set(Object.values(currentUserTimetable.simple).flat())).sort(); }
        function startTracking() { const startDateString = document.getElementById('start-date').value; if (!startDateString) { alert("Please select a Semester Start Date first."); return; } const startDate = new Date(startDateString); const today = new Date(); today.setHours(0, 0, 0, 0); if (startDate > today) { alert("Start date cannot be in the future."); return; } const heldCounts = {}; getUniqueSubjects().forEach(name => heldCounts[name] = 0); let currentDate = new Date(startDate); while (currentDate <= today) { (currentUserTimetable.simple[currentDate.getDay()] || []).forEach(subjectName => { if (heldCounts[subjectName] !== undefined) heldCounts[subjectName]++; }); currentDate.setDate(currentDate.getDate() + 1); } for (const subjectName of getUniqueSubjects()) { subjectData[subjectName] = subjectData[subjectName] || { totalInSem: 0 }; subjectData[subjectName].attended = heldCounts[subjectName] || 0; subjectData[subjectName].bunked = 0; } saveData('attendance'); renderDashboard(); alert("Dashboard calculated and updated with 100% attendance until today!"); }
        function renderTotalAttendance() { const container = document.getElementById('total-stats-container'); const minPercentage = parseFloat(document.getElementById('min-percentage').value) || 75; let totalAttended = 0, totalBunked = 0, totalInSem = 0; for (const subjectName in subjectData) { totalAttended += subjectData[subjectName].attended; totalBunked += subjectData[subjectName].bunked; totalInSem += subjectData[subjectName].totalInSem; } const totalHeld = totalAttended + totalBunked; const totalPercentage = totalHeld > 0 ? (totalAttended / totalHeld) * 100 : 100; const minClassesRequired = Math.ceil(totalInSem * (minPercentage / 100)); const maxBunksAllowed = totalInSem - minClassesRequired; const totalBunksLeft = maxBunksAllowed - totalBunked; container.innerHTML = `<div class="stats-grid"><div class="stat"><div class="label">Total</div><div class="value">${totalPercentage.toFixed(1)}%</div></div><div class="stat"><div class="label">Attended</div><div class="value">${totalAttended}</div></div><div class="stat"><div class="label">Bunked</div><div class="value">${totalBunked}</div></div></div><div class="bunks-left ${totalBunksLeft >= 0 ? 'safe' : 'danger'}">${totalInSem > 0 ? `<strong>${totalBunksLeft}</strong> Total Bunks Left` : 'Configure Subjects in Settings ⚙️'}</div>`; }
        function renderDashboard() { const dashboard = document.getElementById('dashboard'); dashboard.innerHTML = ''; getUniqueSubjects().forEach(subjectName => { if(!subjectData[subjectName]) subjectData[subjectName] = { attended: 0, bunked: 0, totalInSem: 0 }; const data = subjectData[subjectName]; const minPercentage = parseFloat(document.getElementById('min-percentage').value) || 75; const held = data.attended + data.bunked; const percentage = held > 0 ? (data.attended / held) * 100 : 100; const minClassesRequired = Math.ceil(data.totalInSem * (minPercentage / 100)); const maxBunksAllowed = data.totalInSem - minClassesRequired; const bunksLeft = maxBunksAllowed - data.bunked; const card = document.createElement('div'); card.className = `card subject-card ${bunksLeft >= 0 ? 'is-safe' : 'is-danger'}`; card.innerHTML = `<h3>${subjectName}</h3><div class="card-main-stats"><div class="stat"><div class="label">Percentage</div><div class="value">${percentage.toFixed(1)}%</div></div><div class="stat"><div class="label">Bunks Left</div><div class="value">${data.totalInSem > 0 ? bunksLeft : '?'}</div></div></div><div class="card-details">Attended: ${data.attended} | Bunked: ${data.bunked} | Held: ${held}</div><div class="action-area"><button class="bunk-btn" onclick="markBunked('${subjectName}')">Bunk One</button><button class="undo-btn" onclick="undoBunk('${subjectName}')">Undo Bunk</button></div>`; dashboard.appendChild(card); }); renderTotalAttendance(); }
        function markBunked(subjectName) { if (subjectData[subjectName].attended > 0) { subjectData[subjectName].attended--; subjectData[subjectName].bunked++; saveData('attendance'); renderDashboard(); } }
        function undoBunk(subjectName) { if (subjectData[subjectName].bunked > 0) { subjectData[subjectName].attended++; subjectData[subjectName].bunked--; saveData('attendance'); renderDashboard(); } }
        function populateSettingsModal() { const listDiv = document.getElementById('settings-list'); listDiv.innerHTML = ''; getUniqueSubjects().forEach(subjectName => { const totalInSem = subjectData[subjectName]?.totalInSem || 0; const item = document.createElement('div'); item.className = 'settings-item'; item.innerHTML = `<label>${subjectName}</label><input type="number" id="total-${subjectName.replace(/[\s&/]/g, '')}" value="${totalInSem}">`; listDiv.appendChild(item); }); }
        function saveSettings() { getUniqueSubjects().forEach(subjectName => { const inputId = `total-${subjectName.replace(/[\s&/]/g, '')}`; const totalValue = parseInt(document.getElementById(inputId).value); if (!isNaN(totalValue) && subjectData[subjectName]) subjectData[subjectName].totalInSem = totalValue; }); saveData('attendance'); renderDashboard(); closeSettings(); }
        function renderGradeEstimator() { const grid = document.getElementById('grade-estimator-grid'); const savedGrades = JSON.parse(localStorage.getItem(getUserDataKey(getCurrentUserRegdNo(), 'grades'))) || {}; grid.innerHTML = ''; getUniqueSubjects().forEach(subjectName => { const details = courseDetailsByBranch[userDatabase.find(u=>u.regdNo === getCurrentUserRegdNo()).branch][subjectName]; if(!details || details.credits === 0) return; const cleanSubName = subjectName.replace(/[\s&/]/g, ''); const saved = savedGrades[subjectName] || {}; let inputsHTML = ''; if(details.type === 'Theory') { inputsHTML += `<div class="input-group"><label>Internal (40)</label><input type="number" min="0" max="40" id="internal_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.internal || ''}"><div class="validation-message" id="v_internal_${cleanSubName}"></div></div><div class="input-group"><label>External (60)</label><input type="number" min="0" max="60" id="external_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.external || ''}"><div class="validation-message" id="v_external_${cleanSubName}"></div></div>`; } else if (details.type === 'Lab') { inputsHTML += `<div class="input-group"><label>Total Internal (100)</label><input type="number" min="0" max="100" id="lab_internal_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.lab_internal || ''}"><div class="validation-message" id="v_lab_internal_${cleanSubName}"></div></div>`; } else if (details.type === 'Integrated') { inputsHTML += `<div class="input-group"><label>Theory Internal (40)</label><input type="number" min="0" max="40" id="internal_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.internal || ''}"><div class="validation-message" id="v_internal_${cleanSubName}"></div></div><div class="input-group"><label>Theory External (60)</label><input type="number" min="0" max="60" id="external_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.external || ''}"><div class="validation-message" id="v_external_${cleanSubName}"></div></div><div class="input-group"><label>Lab Internal (100)</label><input type="number" min="0" max="100" id="lab_internal_${cleanSubName}" oninput="calculateSubjectGrade('${subjectName}')" value="${saved.lab_internal || ''}"><div class="validation-message" id="v_lab_internal_${cleanSubName}"></div></div>`; } const card = document.createElement('div'); card.className = 'card estimator-card'; card.innerHTML = `<h3>${subjectName} (${details.credits} Cr)</h3><div class="input-grid">${inputsHTML}</div><div class="result-area">Final Grade: <span id="result_${cleanSubName}">-</span></div>`; grid.appendChild(card); }); }
        function calculateSubjectGrade(subjectName, forSGPA = false) { const details = courseDetailsByBranch[userDatabase.find(u=>u.regdNo === getCurrentUserRegdNo()).branch][subjectName]; const cleanSubName = subjectName.replace(/[\s&/]/g, ''); let finalScore = 0; let isFail = false; if (details.type === 'Theory' || details.type === 'Integrated') { const intEl = document.getElementById(`internal_${cleanSubName}`); const extEl = document.getElementById(`external_${cleanSubName}`); const v_int = document.getElementById(`v_internal_${cleanSubName}`); const v_ext = document.getElementById(`v_external_${cleanSubName}`); const internal = parseInt(intEl.value) || 0; const external = parseInt(extEl.value) || 0; let requiredExternal = 24; v_int.innerText = ''; v_ext.innerText = ''; intEl.classList.remove('invalid'); extEl.classList.remove('invalid'); if (internal < 16) { requiredExternal = 24 + (16 - internal); v_int.innerText = 'Min 16 needed'; intEl.classList.add('invalid'); if (external < requiredExternal) { v_ext.innerText = `Min ${requiredExternal} needed`; extEl.classList.add('invalid'); isFail = true; } } else if (external < 24) { v_ext.innerText = 'Min 24 needed'; extEl.classList.add('invalid'); isFail = true; } const theoryTotal = internal + external; if (details.type === 'Theory') { finalScore = theoryTotal; } else if (details.type === 'Integrated') { const labEl = document.getElementById(`lab_internal_${cleanSubName}`); const v_lab = document.getElementById(`v_lab_internal_${cleanSubName}`); const labInternal = parseInt(labEl.value) || 0; v_lab.innerText = ''; labEl.classList.remove('invalid'); if (labInternal < 40) { v_lab.innerText = 'Min 40 needed'; labEl.classList.add('invalid'); isFail = true; } finalScore = (theoryTotal * 0.7) + (labInternal * 0.3); } } else if (details.type === 'Lab') { const labEl = document.getElementById(`lab_internal_${cleanSubName}`); const v_lab = document.getElementById(`v_lab_internal_${cleanSubName}`); const labInternal = parseInt(labEl.value) || 0; v_lab.innerText = ''; labEl.classList.remove('invalid'); if (labInternal < 40) { v_lab.innerText = 'Min 40 needed'; labEl.classList.add('invalid'); isFail = true; } finalScore = labInternal; } const { grade, gradePoint } = getGradeFromMarks(finalScore, isFail); if (!forSGPA) { document.getElementById(`result_${cleanSubName}`).innerText = `${finalScore.toFixed(2)} (${grade})`; saveData('grades'); } return { gradePoint }; }
        function getGradeFromMarks(marks, failStatus) { if (failStatus) return { grade: 'F', gradePoint: 0 }; if (marks >= 90) return { grade: 'O', gradePoint: 10 }; if (marks >= 80) return { grade: 'A+', gradePoint: 9 }; if (marks >= 70) return { grade: 'A', gradePoint: 8 }; if (marks >= 60) return { grade: 'B+', gradePoint: 7 }; if (marks >= 50) return { grade: 'B', gradePoint: 6 }; if (marks >= 45) return { grade: 'C', gradePoint: 5 }; if (marks >= 40) return { grade: 'P', gradePoint: 4 }; return { grade: 'F', gradePoint: 0 }; }
        function calculateSGPA() { let totalCredits = 0, weightedGradePoints = 0; const branch = userDatabase.find(u=>u.regdNo === getCurrentUserRegdNo()).branch; getUniqueSubjects().forEach(subjectName => { const details = courseDetailsByBranch[branch][subjectName]; if (details && details.credits > 0) { const { gradePoint } = calculateSubjectGrade(subjectName, true); totalCredits += details.credits; weightedGradePoints += gradePoint * details.credits; } }); const sgpa = totalCredits > 0 ? (weightedGradePoints / totalCredits) : 0; document.getElementById('sgpa-result').innerText = `Estimated SGPA: ${sgpa.toFixed(2)}`; }
        
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function openTimetableModal() { document.getElementById('timetable-modal').style.display = 'flex'; }
        function closeTimetableModal() { document.getElementById('timetable-modal').style.display = 'none'; }
        
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        window.onload = init;
        window.onclick = function(event) { if (event.target.classList.contains('modal')) { closeSettings(); closeTimetableModal(); } }
    </script>
</body>
</html>
